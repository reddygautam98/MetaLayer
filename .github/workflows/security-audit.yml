name: ğŸ”’ Security Audit & Compliance

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/**'

permissions:
  actions: read
  contents: read
  security-events: write
  id-token: write
  issues: write

jobs:
  # ===========================================
  # DEPENDENCY SECURITY AUDIT
  # ===========================================
  dependency-audit:
    name: ğŸ” Dependency Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ”’ Python Dependency Security Audit
        uses: pypa/gh-action-pip-audit@v1.0.8
        with:
          inputs: requirements.txt
          format: json
          output: pip-audit-report.json

      - name: ğŸ›¡ï¸ Safety Check for Known Vulnerabilities
        run: |
          pip install safety
          safety check --json > safety-report.json || true

      - name: ğŸ“Š Upload Security Audit Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-security-reports
          path: |
            pip-audit-report.json
            safety-report.json

  # ===========================================
  # CONTAINER SECURITY SCANNING
  # ===========================================
  container-security:
    name: ğŸ³ Container Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Build Docker Image for Scanning
        run: |
          docker build -t metalayer-security-scan:latest .

      - name: ğŸ” Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'metalayer-security-scan:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ” Run Grype Vulnerability Scanner
        uses: anchore/scan-action@v3
        id: grype-scan
        with:
          image: 'metalayer-security-scan:latest'
          fail-build: false

      - name: ğŸ”’ Docker Bench Security
        run: |
          docker run --rm --net host --pid host --userns host --cap-add audit_control \
            -e DOCKER_CONTENT_TRUST=$DOCKER_CONTENT_TRUST \
            -v /etc:/etc:ro \
            -v /usr/bin/containerd:/usr/bin/containerd:ro \
            -v /usr/bin/runc:/usr/bin/runc:ro \
            -v /usr/lib/systemd:/usr/lib/systemd:ro \
            -v /var/lib:/var/lib:ro \
            -v /var/run/docker.sock:/var/run/docker.sock:ro \
            --label docker_bench_security \
            docker/docker-bench-security > docker-bench-results.txt || true

      - name: ğŸ“Š Upload Container Security Results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Security Scan Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-security-reports
          path: |
            trivy-results.sarif
            docker-bench-results.txt
            ${{ steps.grype-scan.outputs.sarif }}

  # ===========================================
  # CODE SECURITY ANALYSIS
  # ===========================================
  code-security:
    name: ğŸ”’ Code Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Security Tools
        run: |
          # Install security tools with compatible versions
          python -m pip install --upgrade pip
          
          # Install security tools in isolated environment
          pip install "bandit==1.7.5"
          pip install "safety==3.2.7" --no-deps
          pip install "semgrep==1.142.1"
          pip install "pip-audit==2.6.1"
          
          # Install compatible dependencies
          pip install "typer<0.10.0"
          pip install "marshmallow<4.0.0"

      - name: ğŸ” Run Bandit Security Linter
        run: |
          # Create directories if they don't exist
          mkdir -p dags plugins
          
          # Run bandit with proper error handling
          if [ -d "dags" ] && [ "$(ls -A dags)" ]; then
            bandit -r dags/ -f json -o bandit-security-report.json || echo "Bandit completed with warnings"
          else
            echo "No DAGs directory found, creating empty report"
            echo '{}' > bandit-security-report.json
          fi

      - name: ğŸ” Run Semgrep Security Analysis
        run: |
          # Run semgrep with proper error handling
          if [ -d "dags" ] && [ "$(ls -A dags)" ]; then
            semgrep --config=auto --json --output=semgrep-security-report.json dags/ || echo "Semgrep completed with warnings"
          else
            echo "No code to scan, creating empty report"
            echo '{}' > semgrep-security-report.json
          fi

      - name: Determine commit SHAs
        id: commits
        run: |
          echo "base=${{ github.event.before }}" >> $GITHUB_OUTPUT
          echo "head=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: ğŸ” Check for Secrets in Code (commit-range if available)
        if: ${{ github.event_name == 'push' && github.event.before != github.sha && github.event.before != '0000000000000000000000000000000000000000' }}
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.sha }}
          extra_args: --debug --only-verified

      - name: ğŸ” Check for Secrets in Code (full repo scan fallback)
        if: ${{ github.event_name != 'push' || github.event.before == github.sha || github.event.before == '0000000000000000000000000000000000000000' }}
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

      - name: ğŸ“Š Upload Code Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-security-reports
          path: |
            bandit-security-report.json
            semgrep-security-report.json

  # ===========================================
  # INFRASTRUCTURE SECURITY
  # ===========================================
  infrastructure-security:
    name: ğŸ—ï¸ Infrastructure Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Scan Docker Compose Configuration
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config-results.sarif'

      - name: ğŸ”’ Check for Hardcoded Secrets
        run: |
          # Check for hardcoded passwords, keys, tokens
          echo "ğŸ” Scanning for hardcoded secrets..."
          
          # Check docker-compose files
          if grep -r "password.*=" docker-compose*.yml; then
            echo "âš ï¸  Found potential hardcoded passwords in docker-compose files"
          fi
          
          # Check environment files
          if grep -r "password.*=" .env* 2>/dev/null; then
            echo "âš ï¸  Found potential hardcoded passwords in environment files"
          fi
          
          # Check for API keys
          if grep -ri "api[_-]key\|secret[_-]key\|access[_-]token" --exclude-dir=.git .; then
            echo "âš ï¸  Found potential API keys or tokens"
          fi

      - name: ï¿½ Debug SARIF File
        if: always()
        run: |
          echo "ğŸ“‹ Checking for SARIF files..."
          ls -la *.sarif || echo "No SARIF files found"
          if [ -f "trivy-config-results.sarif" ]; then
            echo "âœ… trivy-config-results.sarif exists"
            echo "ğŸ“Š File size: $(wc -c < trivy-config-results.sarif) bytes"
            echo "ğŸ“„ First few lines:"
            head -10 trivy-config-results.sarif || echo "Cannot read file"
          else
            echo "âŒ trivy-config-results.sarif does not exist"
          fi

      - name: ï¿½ğŸ“Š Upload Infrastructure Security Results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-config-results.sarif') != ''
        with:
          sarif_file: 'trivy-config-results.sarif'

  # ===========================================
  # COMPLIANCE CHECKS
  # ===========================================
  compliance-audit:
    name: ğŸ“‹ Compliance & Best Practices Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“‹ Check Security Best Practices
        run: |
          echo "ğŸ“‹ Running compliance checks..."
          
          # Check if .env files are in .gitignore
          if ! grep -q "\.env" .gitignore 2>/dev/null; then
            echo "âŒ .env files should be in .gitignore"
            exit 1
          else
            echo "âœ… .env files are properly ignored"
          fi
          
          # Check for secure Docker practices
          if grep -q "USER root" Dockerfile && ! grep -q "USER astro\|USER airflow" Dockerfile; then
            echo "âŒ Dockerfile should not run as root user"
            exit 1
          else
            echo "âœ… Dockerfile follows security best practices"
          fi
          
          # Check for HTTPS in production URLs
          if grep -r "http://" docker-compose*.yml | grep -v localhost | grep -v 127.0.0.1; then
            echo "âš ï¸  Found HTTP URLs that should use HTTPS in production"
          fi

      - name: ğŸ“‹ Data Privacy Compliance Check
        run: |
          echo "ğŸ”’ Checking data privacy compliance..."
          
          # Check for PII handling in code
          if grep -ri "ssn\|social.*security\|credit.*card\|password.*plain" dags/ plugins/ 2>/dev/null; then
            echo "âš ï¸  Found potential PII handling - ensure proper encryption"
          fi
          
          # Check for data retention policies
          if ! ls include/sql/ | grep -i "retention\|archive\|purge" >/dev/null 2>&1; then
            echo "âš ï¸  Consider implementing data retention policies"
          fi

      - name: ğŸ“Š Generate Compliance Report
        run: |
          mkdir -p reports
          cat > reports/compliance-report.md << 'EOF'
          # Security & Compliance Audit Report
          
          ## Date: $(date)
          
          ## Security Checks Performed:
          - âœ… Dependency vulnerability scanning
          - âœ… Container security analysis
          - âœ… Code security analysis
          - âœ… Infrastructure security review
          - âœ… Compliance best practices audit
          
          ## Recommendations:
          1. Regularly update dependencies to latest secure versions
          2. Implement secrets management solution
          3. Enable container image scanning in CI/CD
          4. Review and update security policies quarterly
          5. Conduct regular penetration testing
          
          ## Next Review: $(date -d "+3 months")
          EOF

      - name: ğŸ“Š Upload Compliance Report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-audit-report
          path: reports/compliance-report.md

  # ===========================================
  # SECURITY NOTIFICATION
  # ===========================================
  security-notification:
    name: ğŸ“¢ Security Audit Notification
    runs-on: ubuntu-latest
    needs: [dependency-audit, container-security, code-security, infrastructure-security, compliance-audit]
    if: always()
    
    steps:
      - name: ğŸ“¢ Send Security Audit Notification
        uses: 8398a7/action-slack@v3
        if: failure()
        with:
          status: failure
          channel: '#security-alerts'
          webhook_url: ${{ secrets.SECURITY_SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            ğŸš¨ Security Audit Failed for MetaLayer Project
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            
            Please review the security scan results and address any issues immediately.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SECURITY_SLACK_WEBHOOK }}