# Security & Quality Assurance Workflow
name: üõ°Ô∏è Security & Quality Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write
  id-token: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==============================================================================
  # DEPENDENCY VULNERABILITY SCANNING
  # ==============================================================================
  dependency-scan:
    name: üîí Dependency Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: üìÇ Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: üì¶ Install Dependencies (isolated security tools)
      run: |
        python -m pip install --upgrade pip
        # Create a venv for project deps (optional)
        python -m venv .venv
        source .venv/bin/activate
        pip install -r requirements.txt
        deactivate

        # Create a separate venv for security tools so they don't conflict
        python -m venv .venv-security
        source .venv-security/bin/activate
        pip install --upgrade pip
        
        # Pin marshmallow to avoid incompatibility with security tooling that expects marshmallow<4
        pip install "marshmallow<4.0.0"
        
        # Pin typer to a version compatible with the safety CLI (prevents AttributeError: typer.rich_utils)
        pip install "typer<0.10.0"
        
        # Then install the rest of the security tooling
        pip install -r requirements-security.txt

        # Print versions to help debugging in CI logs
        python --version || true
        pip --version || true
        echo "Security tools versions:"
        python -c "import typer, sys; print('typer', getattr(typer,'__version__', 'unknown'))" || true
        safety --version || true
        bandit --version || true
        semgrep --version || true
        pip freeze | grep -E "(typer|safety|bandit|semgrep)" || true
        
    - name: üîç Safety Check (Known Vulnerabilities)
      run: |
        echo "Scanning for known security vulnerabilities..."
        source .venv-security/bin/activate
        safety check --json > safety-report.json || true
        safety check --short-report
        
    - name: üõ°Ô∏è Bandit Security Analysis
      run: |
        echo "Running Bandit security analysis..."
        source .venv-security/bin/activate
        bandit -r dags/ include/ -f json -o bandit-report.json || true
        bandit -r dags/ include/ -ll -i
        
    - name: üîé Semgrep Static Analysis
      run: |
        echo "Running Semgrep static analysis..."
        source .venv-security/bin/activate
        semgrep --config=auto dags/ include/ --json --output=semgrep-report.json || true
        semgrep --config=auto dags/ include/ --severity=ERROR
        
    - name: üìä Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-reports
        path: |
          safety-report.json
          bandit-report.json
          semgrep-report.json
        retention-days: 30
        
    - name: üí¨ Comment Security Results
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          let comment = '## üõ°Ô∏è Security Scan Results\n\n';
          
          // Add safety results
          try {
            const safetyData = JSON.parse(fs.readFileSync('safety-report.json', 'utf8'));
            const vulns = safetyData.vulnerabilities || [];
            comment += `**Dependency Vulnerabilities:** ${vulns.length} found\n`;
          } catch (e) {
            comment += '**Dependency Vulnerabilities:** ‚úÖ None found\n';
          }
          
          // Add bandit results
          try {
            const banditData = JSON.parse(fs.readFileSync('bandit-report.json', 'utf8'));
            const issues = banditData.results || [];
            comment += `**Code Security Issues:** ${issues.length} found\n`;
          } catch (e) {
            comment += '**Code Security Issues:** ‚úÖ None found\n';
          }
          
          comment += '\nSee the Actions tab for detailed reports.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # ==============================================================================
  # CODE QUALITY ANALYSIS
  # ==============================================================================
  code-quality:
    name: üìä Code Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: üìÇ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: üì¶ Install Quality Tools
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install black isort flake8 pylint mypy coverage pytest pytest-cov
        
    - name: üé® Code Formatting (Black)
      run: |
        echo "Checking code formatting..."
        black --check --diff --exclude "\.venv|__pycache__|\.git|node_modules" dags/ include/ tests/ || {
          echo "‚ùå Code formatting issues found. Run 'black --exclude \"\.venv|__pycache__|\.git|node_modules\" dags/ include/ tests/' to fix."
          exit 1
        }
        echo "‚úÖ Code formatting is correct"
        
    - name: üìè Import Sorting (isort)
      run: |
        echo "Checking import sorting..."
        isort --check-only --diff dags/ include/ tests/ || {
          echo "‚ùå Import sorting issues found. Run 'isort dags/ include/ tests/' to fix."
          exit 1
        }
        echo "‚úÖ Import sorting is correct"
        
    - name: üîç Linting (Flake8)
      run: |
        echo "Running Flake8 linting..."
        flake8 dags/ include/ tests/ --count --statistics
        
    - name: üìà Type Checking (MyPy)
      run: |
        echo "Running type checking..."
        mypy dags/ include/ --ignore-missing-imports --no-strict-optional || true
        
    - name: üî¨ Advanced Linting (Pylint)
      run: |
        echo "Running Pylint analysis..."
        pylint dags/ include/ --output-format=json --reports=y > pylint-report.json || true
        pylint dags/ include/ --reports=y --score=y
        
    - name: üß™ Test Coverage Analysis
      run: |
        echo "Running test coverage analysis..."
        if [ -d "tests/" ]; then
          coverage run -m pytest tests/ --tb=short
          coverage report --show-missing
          coverage html
          coverage json
        else
          echo "No tests directory found, skipping coverage analysis"
        fi
        
    - name: üìä Upload Coverage Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: |
          htmlcov/
          coverage.json
          pylint-report.json
        retention-days: 30

  # ==============================================================================
  # DOCKER SECURITY SCANNING
  # ==============================================================================
  docker-security:
    name: üê≥ Docker Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: üìÇ Checkout Repository
      uses: actions/checkout@v4
      
    - name: üîß Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: üèóÔ∏è Build Test Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        load: true
        tags: metalayer:security-test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: üõ°Ô∏è Scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'metalayer:security-test'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
        
    - name: üìä Upload Trivy Results
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('trivy-results.sarif') != ''
      with:
        sarif_file: 'trivy-results.sarif'
        
    - name: üîç Scan with Hadolint (Dockerfile)
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        format: sarif
        output-file: hadolint-results.sarif
        no-fail: true
        
    - name: üìä Upload Hadolint Results
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('hadolint-results.sarif') != ''
      with:
        sarif_file: hadolint-results.sarif

  # ==============================================================================
  # INFRASTRUCTURE SECURITY
  # ==============================================================================
  infrastructure-scan:
    name: üèóÔ∏è Infrastructure Security
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: üìÇ Checkout Repository
      uses: actions/checkout@v4
      
    - name: üîç Scan Docker Compose Files
      run: |
        echo "Scanning Docker Compose files for security issues..."
        
        # Check for hardcoded passwords
        echo "Checking for hardcoded credentials..."
        if grep -r "password.*=" docker-compose*.yml | grep -v "POSTGRES_PASSWORD" | grep -v "admin"; then
          echo "‚ùå Potential hardcoded passwords found in Docker Compose files"
          exit 1
        fi
        
        # Check for exposed ports
        echo "Checking for exposed ports..."
        grep -r "ports:" docker-compose*.yml || echo "No exposed ports found"
        
        # Check for privileged containers
        echo "Checking for privileged containers..."
        if grep -r "privileged.*true" docker-compose*.yml; then
          echo "‚ö†Ô∏è  Privileged containers detected"
        fi
        
        echo "‚úÖ Infrastructure security scan completed"
        
    - name: üîê Check Environment Variables
      run: |
        echo "Checking environment variable security..."
        
        # Look for potential secrets in compose files
        grep -r "environment:" docker-compose*.yml -A 10 | grep -E "(SECRET|KEY|TOKEN|PASSWORD)" || echo "No obvious secrets in environment variables"
        
        echo "‚úÖ Environment variable check completed"

  # ==============================================================================
  # COMPLIANCE REPORTING
  # ==============================================================================
  compliance-report:
    name: üìã Compliance Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-quality, docker-security, infrastructure-scan]
    if: always()
    
    steps:
    - name: üìä Generate Compliance Summary
      run: |
        echo "## üõ°Ô∏è Security & Compliance Report" >> compliance-report.md
        echo "Generated on: $(date)" >> compliance-report.md
        echo "" >> compliance-report.md
        
        echo "### Job Results" >> compliance-report.md
        echo "| Check | Status |" >> compliance-report.md
        echo "|-------|--------|" >> compliance-report.md
        echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> compliance-report.md
        echo "| Code Quality | ${{ needs.code-quality.result == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> compliance-report.md
        echo "| Docker Security | ${{ needs.docker-security.result == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> compliance-report.md
        echo "| Infrastructure | ${{ needs.infrastructure-scan.result == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> compliance-report.md
        echo "" >> compliance-report.md
        
        echo "### Security Standards Compliance" >> compliance-report.md
        echo "- ‚úÖ OWASP Top 10 checks performed" >> compliance-report.md
        echo "- ‚úÖ Dependency vulnerability scanning" >> compliance-report.md
        echo "- ‚úÖ Static code analysis" >> compliance-report.md
        echo "- ‚úÖ Container image scanning" >> compliance-report.md
        echo "- ‚úÖ Infrastructure configuration review" >> compliance-report.md
        
        cat compliance-report.md
        
    - name: üì§ Upload Compliance Report
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report
        path: compliance-report.md
        retention-days: 90