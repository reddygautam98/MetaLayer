name: MetaLayer Security Scan

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Mondays at 2 AM
  workflow_dispatch:
  push:
    paths:
      - 'requirements.txt'
      - 'Dockerfile'

jobs:
  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          # Install security tools with compatible versions
          pip install -r requirements-security.txt
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Bandit security scan
        run: |
          echo "ðŸ›¡ï¸ Running Bandit security scan..."
          bandit -r . -f json -o bandit-report.json -x tests/,venv/,.github/ || true

      - name: Run Safety vulnerability check
        run: |
          echo "ðŸ”’ Checking for known vulnerabilities..."
          safety check --json > safety-report.json || true

      - name: Run Semgrep security analysis
        run: |
          echo "ðŸ” Running Semgrep analysis..."
          semgrep --config=auto --json --output=semgrep-report.json . || true

      - name: Docker image security scan
        run: |
          echo "ðŸ³ Building and scanning Docker image..."
          docker build -t metalayer-security-scan:latest .
          
          # Install Trivy
          sudo apt-get update && sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update && sudo apt-get install trivy
          
          # Scan the image
          trivy image --format json --output docker-scan-report.json metalayer-security-scan:latest

      - name: Generate security report
        run: |
          echo "ðŸ“‹ Generating security summary..."
          cat > security-summary.md << EOF
          # ðŸ”’ MetaLayer Security Scan Report
          
          **Scan Date:** $(date)
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          
          ## ðŸ“Š Scan Results
          
          ### Bandit (Python Security)
          $(if [ -f bandit-report.json ]; then echo "âœ… Completed - See artifacts"; else echo "âŒ Failed"; fi)
          
          ### Safety (Dependency Vulnerabilities)
          $(if [ -f safety-report.json ]; then echo "âœ… Completed - See artifacts"; else echo "âŒ Failed"; fi)
          
          ### Semgrep (Code Analysis)
          $(if [ -f semgrep-report.json ]; then echo "âœ… Completed - See artifacts"; else echo "âŒ Failed"; fi)
          
          ### Docker Image Scan
          $(if [ -f docker-scan-report.json ]; then echo "âœ… Completed - See artifacts"; else echo "âŒ Failed"; fi)
          
          ## ðŸ›¡ï¸ Security Recommendations
          
          1. **Regular Updates**: Keep dependencies updated
          2. **Secrets Management**: Use GitHub Secrets for sensitive data
          3. **Access Control**: Implement proper RBAC
          4. **Network Security**: Use secure communication protocols
          5. **Monitoring**: Enable security monitoring and alerting
          
          EOF

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_number }}
          path: |
            bandit-report.json
            safety-report.json  
            semgrep-report.json
            docker-scan-report.json
            security-summary.md
          retention-days: 30

      - name: Create security issue on failures
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const title = `ðŸ”’ Security Scan Failed - ${context.sha.substring(0, 7)}`;
            const body = `
            ## Security Scan Failure Report
            
            **Commit:** ${context.sha}
            **Branch:** ${context.ref}
            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            
            One or more security scans have failed. Please review the workflow logs and address any security issues.
            
            ### Actions Required:
            - [ ] Review workflow logs
            - [ ] Address security findings
            - [ ] Update dependencies if needed
            - [ ] Re-run security scan
            
            **Auto-generated by GitHub Actions**
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automated', 'priority-high']
            });